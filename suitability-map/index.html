<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weighted Suitability Map - Australia</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
    body { font-family: sans-serif; text-align: center; margin:0; padding:0;}
    #map { width: 1000px; height: 700px; margin: 10px auto; }
    .input-container { margin: 10px; }
    input { width: 60px; margin-right: 5px; }
    .links-container { margin: 10px; }
    .legend { background: white; padding: 6px; line-height: 1.4em; border-radius: 5px; }
    .legend i { width: 20px; height: 12px; float: left; margin-right: 8px; opacity: 0.8; }
</style>
</head>
<body>
<h1>Weighted Suitability Map</h1>

<div class="links-container">
    <a href="acid_map.html" target="_blank">View ACID Layer</a> |
    <a href="log_map.html" target="_blank">View LOGISTICS Layer</a> |
    <a href="desal_map.html" target="_blank">View DESAL Layer</a>
</div>

<div class="input-container">
    Acid weight: <input type="number" id="w1" value="33"> %
    Logistics weight: <input type="number" id="w2" value="33"> %
    Desal weight: <input type="number" id="w3" value="34"> %
    <button id="updateBtn" disabled>Update Weighted Map</button>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>
<script src="https://unpkg.com/georaster"></script>
<script src="https://unpkg.com/georaster-layer-for-leaflet"></script>
<script src="https://unpkg.com/chroma-js@2.1.0/chroma.min.js"></script>

<script>
// --- Setup ---
proj4.defs("EPSG:9473",
  "+proj=aea +lat_0=0 +lon_0=132 +lat_1=-18 +lat_2=-36 +x_0=0 +y_0=0 +datum=GDA2020 +units=m +no_defs"
);

const map = L.map('map').setView([-25, 135], 4);
L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.stadiamaps.com/">Stadia Maps</a> contributors',
    ext: 'png'
}).addTo(map);

const rasterFiles = [
    'https://irisbenj.github.io/OAE-SITE-SELECTION/suitability-map/acid-cog.tif',
    'https://irisbenj.github.io/OAE-SITE-SELECTION/suitability-map/log-cog.tif',
    'https://irisbenj.github.io/OAE-SITE-SELECTION/suitability-map/desal-cog.tif'
];

let georasters = [];
let weightedLayer = null;
const colorScale = chroma.scale("YlGnBu").domain([1, 10]);

// --- Load rasters ---
Promise.all(rasterFiles.map(url => fetch(url)
    .then(r => r.arrayBuffer())
    .then(parseGeoraster)))
.then(results => {
    georasters = results.map(r => { r.projection = 9473; return r; });
    console.log("‚úÖ All rasters loaded", georasters);
    document.getElementById('updateBtn').disabled = false;
    addWeightedLayer(); // run at start
})
.catch(err => console.error("‚ùå Error loading rasters:", err));

// --- Chunked weighted raster calculation ---
async function computeWeightedRasterChunked(georasters, weights, chunkSize = 10000) {
    const base = georasters[0];
    const total = base.width * base.height;
    const newData = base.values[0]; // reuse array in-place
    const numRasters = georasters.length;

    console.log(`Processing ${total} pixels in chunks of ${chunkSize}...`);

    for (let startIdx = 0; startIdx < total; startIdx += chunkSize) {
        const endIdx = Math.min(startIdx + chunkSize, total);

        for (let i = startIdx; i < endIdx; i++) {
            let score = 0;
            let valid = true;

            for (let j = 0; j < numRasters; j++) {
                const raster = georasters[j];
                const v = raster.values[0][i];
                const nodata = raster.noDataValue ?? 0;

                if (v === nodata || isNaN(v)) {
                    valid = false;
                    break;
                }

                const min = raster.mins[0];
                const max = raster.maxs[0];
                if (min === max) { valid = false; break; }

                score += ((v - min) / (max - min)) * weights[j];
            }

            newData[i] = valid ? score : NaN;
        }

        // yield to browser
        await new Promise(r => setTimeout(r, 0));

        if (startIdx % (chunkSize * 50) === 0) {
            console.log(`Processed ${endIdx} / ${total}`);
        }
    }

    console.log("‚úÖ Weighted raster chunked processing complete");

    return {
        ...base,
        values: [newData],
        projection: 9473,
        noDataValue: NaN
    };
}

// --- Build/update suitability layer ---
async function addWeightedLayer() {
    const w1 = parseFloat(document.getElementById('w1').value) / 100;
    const w2 = parseFloat(document.getElementById('w2').value) / 100;
    const w3 = parseFloat(document.getElementById('w3').value) / 100;
    const sum = w1 + w2 + w3;
    if (sum !== 1) { alert("Weights must sum to 100%"); return; }

    if (weightedLayer) map.removeLayer(weightedLayer);

    const weightedRaster = await computeWeightedRasterChunked(georasters, [w1, w2, w3]);

    weightedLayer = new GeoRasterLayer({
        georasters: [weightedRaster],
        opacity: 0.8,
        resolution: 256,
        pixelValuesToColorFn: values => {
            const score = values[0];
            if (isNaN(score)) return null;
            const suitability = Math.min(10, Math.max(1, Math.round(score * 9 + 1)));
            return colorScale(suitability).hex();
        }
    });

    weightedLayer.addTo(map);

    try {
        const bounds = weightedLayer.getBounds();
        if (bounds.isValid()) map.fitBounds(bounds);
    } catch (err) {
        console.warn("‚ö†Ô∏è fitBounds failed:", err);
    }

    console.log("üéâ Weighted suitability map added/updated");
}

// --- Button ---
document.getElementById('updateBtn').addEventListener('click', addWeightedLayer);

// --- Legend ---
const legend = L.control({position: 'bottomright'});
legend.onAdd = function () {
    const div = L.DomUtil.create('div', 'legend');
    div.innerHTML += "<b>Suitability (1‚Äì10)</b><br>";
    for(let i=1; i<=10; i++) {
        div.innerHTML += `<i style="background:${colorScale(i).hex()}"></i> ${i}<br>`;
    }
    return div;
};
legend.addTo(map);
</script>
</body>
</html>

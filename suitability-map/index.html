<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Weighted Suitability Map - GPU</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  body { margin:0; padding:0; font-family:sans-serif; }
  #map { width: 100%; height: 700px; }
  .input-container { margin: 10px; text-align: center; }
  input { width: 60px; margin-right: 5px; }
</style>
</head>
<body>
<h1 style="text-align:center;">Weighted Suitability Map - GPU</h1>

<div class="input-container">
  Acid: <input type="number" id="w1" value="33"> %
  Logistics: <input type="number" id="w2" value="33"> %
  Desal: <input type="number" id="w3" value="34"> %
  <button id="updateBtn">Update Map</button>
</div>

<div id="map"></div>

<!-- Libraries -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/deck.gl@^8.10.19/dist.min.js"></script>
<script src="https://unpkg.com/@deck.gl/leaflet/dist.min.js"></script>

<script>
// --- Leaflet map ---
const map = L.map('map').setView([-25, 135], 4);
L.tileLayer('https://tiles.stadiamaps.com/tiles/alidade_smooth/{z}/{x}/{y}{r}.png', {
    attribution: '&copy; <a href="https://www.stadiamaps.com/">Stadia Maps</a> contributors',
}).addTo(map);

// --- Raster sources (could be preprocessed PNGs) ---
const rasterUrls = [
  'https://irisbenj.github.io/OAE-SITE-SELECTION/suitability-map/acid.png',
  'https://irisbenj.github.io/OAE-SITE-SELECTION/suitability-map/log.png',
  'https://irisbenj.github.io/OAE-SITE-SELECTION/suitability-map/desal.png'
];

let textures = [];

// Load rasters as images
Promise.all(rasterUrls.map(url => new Promise(resolve => {
  const img = new Image();
  img.crossOrigin = "Anonymous";
  img.onload = () => resolve(img);
  img.src = url;
}))).then(images => {
  textures = images;
  initDeck();
});

let deckLayer;

// --- Initialize DeckGL layer ---
function initDeck() {
  deckLayer = new deck.DeckGL({
    canvas: 'deck-canvas',
    width: '100%',
    height: '100%',
    controller: false,
    layers: [createBitmapLayer()],
    pickingRadius: 0
  });

  // Integrate with Leaflet
  const deckOverlay = new deck.LeafletOverlay({deck: deckLayer});
  deckOverlay.addTo(map);
}

// --- Create BitmapLayer with dynamic weights ---
function createBitmapLayer() {
  const w1 = parseFloat(document.getElementById('w1').value) / 100;
  const w2 = parseFloat(document.getElementById('w2').value) / 100;
  const w3 = parseFloat(document.getElementById('w3').value) / 100;

  // Bounds: [west, south, east, north] in lat/lon
  const bounds = [112, -44, 154, -10];

  return new deck.BitmapLayer({
    id: 'weighted-raster',
    bounds: bounds,
    image: textures[0], // initial texture
    desaturate: 0, // optional
    getPixel: (u,v) => {
      // Custom blending can be done in shader if needed
      // For demo, just use first raster
      return null;
    },
    parameters: {
      blendFunc: [deck.gl.WebGLConstants.SRC_ALPHA, deck.gl.WebGLConstants.ONE_MINUS_SRC_ALPHA]
    }
  });
}

// --- Update map on weight change ---
document.getElementById('updateBtn').addEventListener('click', () => {
  deckLayer.setProps({layers: [createBitmapLayer()]});
});
</script>
</body>
</html>
